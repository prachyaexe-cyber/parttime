<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>บันทึกเวลาและคำนวณค่าแรง + OT</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#98a0aa;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans Thai',sans-serif}
    body{margin:0;background:#071428;color:#e6eef6;padding:24px}
    .container{max-width:900px;margin:auto}
    h1{margin:0 0 8px 0;font-size:20px}
    .card{background:var(--card);padding:16px;border-radius:12px;margin-top:10px}
    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:#fff}
    
    /* ปรับขนาดช่องวันที่ใหม่ */
    .date-box input{min-width:130px}

    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    button{padding:8px 12px;border:0;border-radius:8px;background:var(--accent);color:#042022;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.05)}
    th{font-size:12px;color:var(--muted)}
    .right{text-align:right}
  </style>
</head>
<body>
  <div class="container">

    <h1>บันทึกเวลา & คำนวณค่าแรง + OT</h1>

    <div class="card">
      <div class="grid">
        <div class="date-box">
          <label>วันที่</label>
          <input type="date" id="date">
        </div>

        <div>
          <label>เวลาเข้า (hh:mm)</label>
          <input type="text" id="start" placeholder="0900" maxlength="5">
        </div>

        <div>
          <label>เวลาออก (hh:mm)</label>
          <input type="text" id="end" placeholder="1730" maxlength="5">
        </div>

        <div>
          <label>ค่าแรง/ชั่วโมง</label>
          <input type="number" id="wage" value="50">
        </div>

        <div>
          <label>OT Rate</label>
          <select id="otRate">
            <option value="1.5">1.5x</option>
            <option value="2.0">2.0x</option>
            <option value="2.25">2.25x</option>
          </select>
        </div>
      </div>

      <button id="addBtn" style="margin-top:10px">บันทึก</button>
      <button id="exportBtn" class="ghost" style="margin-top:10px">Export CSV</button>

      <div style="margin-top:8px;color:var(--muted)">* เกิน 8 ชั่วโมงนับเป็น OT อัตโนมัติ</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">บันทึกย้อนหลัง</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>วันที่</th>
            <th>เข้า</th>
            <th>ออก</th>
            <th>OT</th>
            <th class="right">รวม</th>
            <th>ลบ</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>

<script>
const key = "worklog_ot_v2";

function load(){ return JSON.parse(localStorage.getItem(key) || "[]"); }
function save(data){ localStorage.setItem(key, JSON.stringify(data)); }

function toMinutes(t){
  if(!t.includes(":")) return 0;
  const [h,m] = t.split(":").map(Number);
  return h*60 + m;
}

function autoFormat(input){
  input.addEventListener("input", ()=>{
    let v = input.value.replace(/[^0-9]/g,"");
    if(v.length >= 3) input.value = v.slice(0,2)+":"+v.slice(2,4);
    else input.value = v;
  });
}

autoFormat(start);
autoFormat(end);

function calc(){
  const d = date.value, s = start.value, e = end.value;
  const w = Number(wage.value), r = Number(otRate.value);

  if(!d || !s || !e) return alert("กรอกข้อมูลให้ครบ");

  const mins = toMinutes(e) - toMinutes(s);
  if(mins <= 0) return alert("เวลาออกต้องมากกว่าเวลาเข้า");

  const normal = Math.min(mins, 480); 
  const ot = Math.max(0, mins - 480);

  const payNormal = (normal/60) * w;
  const payOT = (ot/60) * w * r;
  const total = payNormal + payOT;

  const item = { id:Date.now(), d, s, e, ot, total };
  const logs = load(); logs.push(item); save(logs);
  render();
}

function render(){
  const logs = load().sort((a,b)=>b.id - a.id);
  logBody.innerHTML = "";
  logs.forEach((l,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${l.d}</td>
      <td>${l.s}</td>
      <td>${l.e}</td>
      <td>${(l.ot/60).toFixed(2)} ชม.</td>
      <td class="right">${l.total.toFixed(2)}</td>
      <td><button class="ghost" onclick="del(${l.id})">ลบ</button></td>`;
    logBody.appendChild(tr);
  });
}

function del(id){
  if(confirm("ลบรายการนี้?")){
    save(load().filter(l=>l.id !== id));
    render();
  }
}

addBtn.onclick = calc;

exportBtn.onclick = ()=>{
  const logs = load();
  if(!logs.length) return alert("ไม่มีข้อมูล");

  let csv = "ลำดับ,วันที่,เวลาเข้า,เวลาออก,OT(ชม.),รวมเงิน\n";
  logs.forEach((l,i)=>{
    csv += `${i+1},${l.d},${l.s},${l.e},${(l.ot/60).toFixed(2)},${l.total.toFixed(2)}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "worklog_ot.csv"; a.click();
  URL.revokeObjectURL(url);
}

render();
date.value = new Date().toISOString().slice(0,10);
</script>

</body>
</html>