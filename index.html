<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>บันทึกเวลาทำงาน & OT</title>
<style>
body { font-family: Tahoma; padding: 20px; max-width: 800px; margin: auto; }
input { padding: 6px; margin: 4px 0; font-size: 16px; }
label { font-weight: bold; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #666; padding: 6px; text-align: center; }
.total-box { background: #f2f2f2; padding: 10px; margin-top: 15px; font-size: 18px; }
.form-row { display: flex; gap: 10px; flex-wrap: wrap; }
.form-row div { flex: 1; min-width: 150px; }
button { padding: 8px 14px; font-size: 16px; margin-top: 10px; cursor: pointer; }
</style>
</head>
<body>

<h2>ระบบบันทึกเวลาทำงาน & คำนวณ OT</h2>

<div class="form-row">
  <div>
    <label>วันที่</label><br>
    <input type="date" id="date">
  </div>
  <div>
    <label>เวลาเข้า</label><br>
    <input type="text" id="start" placeholder="เช่น 09:00" oninput="autoTimeFormat(this)">
  </div>
  <div>
    <label>เวลาออก</label><br>
    <input type="text" id="end" placeholder="เช่น 17:30" oninput="autoTimeFormat(this)">
  </div>
</div>

<button onclick="addWork()">บันทึกข้อมูล</button>

<table id="workTable">
  <thead>
    <tr>
      <th>ลำดับ</th>
      <th>วันที่</th>
      <th>เวลาเข้า</th>
      <th>เวลาออก</th>
      <th>OT (ชม.)</th>
      <th>รวมเงิน (฿)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="total-box" id="summary"></div>

<button onclick="exportExcel()">ดาวน์โหลด Excel</button>

<script>
let record = [];
const ratePerDay = 500;
const workHoursBase = 8;
const breakHours = 1;
const otRate = (ratePerDay / workHoursBase) * 1.5;

function autoTimeFormat(input) {
  let v = input.value.replace(/[^0-9]/g,"");
  if (v.length >= 3) input.value = v.slice(0,2) + ":" + v.slice(2,4);
}

function timeToHours(t) {
  let [h,m] = t.split(":").map(Number);
  return h + (m/60);
}

function addWork() {
  let date = document.getElementById("date").value;
  let start = document.getElementById("start").value;
  let end = document.getElementById("end").value;
  if(!date || !start || !end || start.length!==5 || end.length!==5) return alert("กรุณากรอกข้อมูลให้ครบและเวลาเป็นรูปแบบ HH:MM");

  let hours = timeToHours(end) - timeToHours(start) - breakHours;
  if (hours < 0) return alert("เวลาออกต้องมากกว่าเวลาเข้า");

  let ot = Math.max(0, hours - workHoursBase);
  let normalHours = Math.min(hours, workHoursBase);
  let total = (normalHours * (ratePerDay/workHoursBase)) + (ot * otRate);

  record.push({ date, start, end, ot, total });
  renderTable();
}

function renderTable(){
  let tbody = document.querySelector("#workTable tbody");
  tbody.innerHTML = "";
  let totalDays = record.length;
  let totalOT = record.reduce((s,r)=>s+r.ot,0);
  let totalMoney = record.reduce((s,r)=>s+r.total,0);

  record.forEach((r,i)=>{
    let row = `<tr>
      <td>${i+1}</td>
      <td>${r.date}</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${r.ot.toFixed(2)}</td>
      <td>${r.total.toFixed(2)}</td>
    </tr>`;
    tbody.innerHTML += row;
  });

  document.getElementById("summary").innerHTML =
    `รวมทั้งหมด: <b>${totalDays}</b> วัน | OT: <b>${totalOT.toFixed(2)}</b> ชม. | รวมเงิน: <b>${totalMoney.toFixed(2)}</b> บาท`;
}

function exportExcel() {
  let csv = "ลำดับ,วันที่,เวลาเข้า,เวลาออก,OT,รวมเงิน\n";
  record.forEach((r,i)=>{
    csv += `${i+1},${r.date},${r.start},${r.end},${r.ot.toFixed(2)},${r.total.toFixed(2)}\n`;
  });
  let blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "work_record.csv";
  link.click();
}
</script>

</body>
</html>