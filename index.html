<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>คิดค่าแรง + OT</title>
<style>
    body { font-family: Tahoma, sans-serif; padding: 20px; max-width: 450px; margin: auto; }
    label { display: block; margin-top: 8px; }
    input { padding: 6px; width: 100%; margin-top: 3px; font-size: 16px; }
    button { margin-top: 10px; padding: 10px; width: 100%; font-size: 16px; }
    .row { display: flex; gap: 10px; }
    .row .col { flex: 1; }
    table { width: 100%; margin-top: 15px; border-collapse: collapse; }
    table, th, td { border: 1px solid #aaa; }
    th, td { padding: 5px; text-align: center; font-size: 14px; }
</style>
</head>
<body>

<h2>ระบบคิดค่าแรง + OT</h2>

<label>วันที่</label>
<input type="date" id="date">

<div class="row">
  <div class="col">
    <label>เวลาเข้า</label>
    <input type="text" id="start" placeholder="เช่น 09:00" maxlength="5">
  </div>
  <div class="col">
    <label>เวลาออก</label>
    <input type="text" id="end" placeholder="เช่น 17:30" maxlength="5">
  </div>
</div>

<button onclick="addLog()">บันทึกการทำงาน</button>
<button onclick="downloadCSV()">ดาวน์โหลดสรุปงาน (CSV)</button>

<h3>ประวัติ</h3>
<table>
  <thead>
    <tr>
      <th>ลำดับ</th>
      <th>วันที่</th>
      <th>เข้า</th>
      <th>ออก</th>
      <th>OT</th>
      <th>รวม</th>
    </tr>
  </thead>
  <tbody id="logTable"></tbody>
</table>

<script>
let logs = JSON.parse(localStorage.getItem("wageLogs") || "[]");
const rate = 50; // ค่าชั่วโมง
const normalHours = 8; // ชั่วโมงปกติ/วัน
const otRate = 1.5; // เรท OT = 1.5 เท่า

function autoTimeFormat(input){
    input.addEventListener("input", e=>{
        let v = e.target.value.replace(/[^0-9]/g,"");
        if(v.length >= 3) e.target.value = v.slice(0,2) + ":" + v.slice(2,4);
        else e.target.value = v;
    });
}
autoTimeFormat(start);
autoTimeFormat(end);

function calcMinutes(t){
    const [h,m] = t.split(":").map(Number);
    return h*60 + m;
}

function addLog(){
    let date = document.getElementById("date").value;
    let start = document.getElementById("start").value;
    let end = document.getElementById("end").value;
    if(!date || !start || !end) return alert("กรุณากรอกข้อมูลให้ครบ");

    let workMin = calcMinutes(end) - calcMinutes(start);
    if(workMin <= 0) return alert("เวลาไม่ถูกต้อง");

    let workHours = workMin / 60;
    let otHours = Math.max(0, workHours - normalHours);
    let normalPay = Math.min(workHours, normalHours) * rate;
    let otPay = otHours * rate * otRate;
    let total = normalPay + otPay;

    logs.push({date,start,end,ot: otHours.toFixed(2), total: total.toFixed(2)});
    localStorage.setItem("wageLogs", JSON.stringify(logs));
    renderTable();
}

function renderTable(){
    const tb = document.getElementById("logTable");
    tb.innerHTML = "";
    logs.forEach((l,i)=>{
        tb.innerHTML += `<tr>
            <td>${i+1}</td>
            <td>${l.date}</td>
            <td>${l.start}</td>
            <td>${l.end}</td>
            <td>${l.ot}</td>
            <td>${l.total}</td>
        </tr>`;
    });
}
renderTable();

function downloadCSV(){
    let csv = "ลำดับ,วันที่,เข้า,ออก,OT,รวม\n";
    logs.forEach((l,i)=>{
        csv += `${i+1},${l.date},${l.start},${l.end},${l.ot},${l.total}\n`;
    });
    let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "สรุปค่าแรงOT.csv";
    a.click();
}
</script>
</body>
</html>