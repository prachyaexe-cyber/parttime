<script>
const key = "worklog_cloud_v1";

function loadLogs(){ 
    try{ return JSON.parse(localStorage.getItem(key)) || [] }catch{return []}
}
function saveLogs(list){ 
    localStorage.setItem(key,JSON.stringify(list)); 
}

function autoTime(input){
 input.addEventListener("input",()=>{
   let v=input.value.replace(/[^0-9]/g,"");
   if(v.length>=3) input.value=v.substring(0,2)+":"+v.substring(2,4);
   else input.value=v;
 });
}
autoTime(startTime);
autoTime(endTime);

function toMinutes(t){
 let [h,m]=t.split(":").map(Number);
 return h*60+m;
}

function render(){
 const logs=loadLogs();
 const body=document.getElementById("logBody");
 body.innerHTML="";

 let totalOT=0,totalIncome=0;

 logs.forEach((l,i)=>{
   totalOT+=l.otHours;
   totalIncome+=l.total;

   body.innerHTML+=`
     <tr>
       <td>${i+1}</td>
       <td>${l.date}</td>
       <td>${l.start}</td>
       <td>${l.end}</td>
       <td>${l.otHours.toFixed(2)}</td>
       <td class="right">${l.total.toFixed(2)}</td>
       <td><button onclick="editItem(${i})">แก้ไข</button></td>
       <td><button onclick="deleteItem(${i})">ลบ</button></td>
     </tr>
   `;
 });

 document.getElementById("totalDays").textContent = logs.length;
 document.getElementById("totalOT").textContent = totalOT.toFixed(2);
 document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
}

document.getElementById("addBtn").onclick=()=>{

 const date = document.getElementById("dateInput").value;
 const s = document.getElementById("startTime").value;
 const e = document.getElementById("endTime").value;
 const br = Number(document.getElementById("breakHours").value||0);
 const wage = Number(document.getElementById("wage").value||0);
 const otRate = Number(document.getElementById("otRate").value);

 if(!date || !s || !e) return alert("กรอกข้อมูลให้ครบ");

 let mStart = toMinutes(s);
 let mEnd = toMinutes(e);

 if(mEnd < mStart) mEnd += 1440;

 let totalWork = (mEnd - mStart) / 60;

 // หักพัก
 let normal = totalWork - br;
 if(normal < 0) normal = 0;

 let ot = totalWork - normal;

 let money = (normal*wage) + (ot*wage*otRate);

 const logs = loadLogs();
 logs.push({date,start:s,end:e,break:br,otHours:ot,total:money});
 saveLogs(logs);

 render();

 document.getElementById("startTime").value="";
 document.getElementById("endTime").value="";
};

// ------- แก้ไขข้อมูล -------
function editItem(i){
 const logs = loadLogs();
 const item = logs[i];

 document.getElementById("dateInput").value = item.date;
 document.getElementById("startTime").value = item.start;
 document.getElementById("endTime").value = item.end;
 document.getElementById("breakHours").value = item.break;

 logs.splice(i,1);
 saveLogs(logs);
 render();
}

// ------- ลบข้อมูล -------
function deleteItem(i){
 if(!confirm("ลบรายการนี้?")) return;
 const logs = loadLogs();
 logs.splice(i,1);
 saveLogs(logs);
 render();
}

document.getElementById("clearBtn").onclick=()=>{
 if(confirm("ลบทั้งหมด?")){
   localStorage.removeItem(key);
   render();
 }
};

document.getElementById("exportBtn").onclick=()=>{
 const logs=loadLogs();
 if(!logs.length) return alert("ไม่มีข้อมูล");

 let csv="ลำดับ,วันที่,เข้า,ออก,พัก,OT(ชม.),รวม(บาท)\n";
 logs.forEach((l,i)=>{
   csv+=`${i+1},${l.date},${l.start},${l.end},${l.break},${l.otHours},${l.total}\n`;
 });

 const blob=new Blob([csv],{type:"text/csv"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;
 a.download="worklog.csv";
 a.click();
 URL.revokeObjectURL(url);
};

render();
</script>
